<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix my track</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6affcb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .tile-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            text-align: center;
            padding: 40px 30px;
            position: relative;
            transition: transform 0.3s ease;
        }
        
        .tile-container:hover {
            transform: translateY(-5px);
        }
        
        .tile-header {
            margin-bottom: 30px;
        }
        
        .tile-header h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .tile-header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 15px;
            padding: 30px 20px;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: #f8f9fa;
        }
        
        .upload-area:hover {
            background: #e8f4ff;
            border-color: #2980b9;
        }
        
        .upload-area i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
            display: block;
        }
        
        .upload-area h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .upload-area p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        #fileInput {
            display: none;
        }
        
        .file-info {
            background: #e8f4ff;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            display: none;
        }
        
        .file-info p {
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .file-info p:last-child {
            margin-bottom: 0;
        }
        
        .file-info i {
            color: #3498db;
            margin-right: 8px;
        }
        
        .btn {
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            max-width: 250px;
            margin: 0 auto;
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.6);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .spinner-container {
            margin: 30px 0;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(52, 152, 219, 0.2);
            border-top: 5px solid #3498db;
            border-radius: 50%;
            margin: 0 auto;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-text {
            color: #2c3e50;
            margin-top: 15px;
            font-weight: 500;
            min-height: 24px;
        }
        
        .result-container {
            display: none;
            margin-top: 25px;
            background: #e8f4ff;
            border-radius: 15px;
            padding: 20px;
            text-align: left;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-container h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        
        .result-container h3 i {
            margin-right: 10px;
            color: #3498db;
        }
        
        .download-link {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-decoration: none;
            color: #2c3e50;
            font-weight: 500;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .download-link:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            background: #f8f9fa;
        }
        
        .download-link i {
            margin-right: 10px;
            font-size: 24px;
            color: #3498db;
        }
        
        .file-details {
            flex-grow: 1;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .file-size {
            font-size: 13px;
            color: #7f8c8d;
        }
        
        .download-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .download-btn:hover {
            background: #2980b9;
        }
        
        .footer {
            margin-top: 25px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        @media (max-width: 500px) {
            .tile-container {
                padding: 30px 20px;
            }
            
            .tile-header h1 {
                font-size: 24px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 15px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="tile-container">
        <div class="tile-header">
            <h1><i class="fas fa-file-export"></i>Обработка gpx и fit файлов</h1>
            <p>для фильтрации фейковых gps данных</p>
        </div>
        
        <div class="upload-area" id="dropArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <h3>Перетащите файл сюда</h3>
            <p>или</p>
            <button class="btn" id="selectBtn">Выбрать файл</button>
            <input type="file" id="fileInput">
        </div>
        
        <div class="file-info" id="fileInfo">
            <p><i class="fas fa-file"></i> <strong>Имя файла:</strong> <span id="fileName"></span></p>
            <p hidden display=none><i class="fas fa-weight-hanging"></i> <strong>Размер:</strong> <span id="fileSize"></span></p>
        </div>
        
        <button class="btn" id="processBtn" disabled>Обработать файл</button>
        
        <div class="spinner-container" id="spinner">
            <div class="spinner"></div>
            <div class="status-text" id="statusText">Обработка файла...</div>
        </div>
        
        <div class="result-container" id="resultContainer">
            <h3><i class="fas fa-check-circle"></i> Файл успешно обработан</h3>
            <p>Ваш файл готов к скачиванию:</p>
            
            <a href="#" class="download-link" id="downloadLink">
                <i class="fas fa-file-download"></i>
                <div class="file-details">
                    <div class="file-name" id="resultFileName"></div>
                    <div hidden class="file-size" id="resultFileSize"></div>
                </div>
                <div class="download-btn">Скачать</div>
            </a>
        </div>
        
        <div class="footer">
            <p>Поддерживаются файлы gpx и fit до 30 МБ</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            const selectBtn = document.getElementById('selectBtn');
            const processBtn = document.getElementById('processBtn');
            const dropArea = document.getElementById('dropArea');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const spinner = document.getElementById('spinner');
            const statusText = document.getElementById('statusText');
            const resultContainer = document.getElementById('resultContainer');
            const downloadLink = document.getElementById('downloadLink');
            const resultFileName = document.getElementById('resultFileName');
            const resultFileSize = document.getElementById('resultFileSize');
            
            let processedFileBlob = null;
            let processedFileName = "";
            
            // Обработка выбора файла через кнопку
            selectBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Обработка выбора файла через input
            fileInput.addEventListener('change', handleFileSelect);
            
            // Обработка перетаскивания файла
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.style.backgroundColor = '#d6eaf8';
                dropArea.style.borderColor = '#2980b9';
            }
            
            function unhighlight() {
                dropArea.style.backgroundColor = '#f8f9fa';
                dropArea.style.borderColor = '#3498db';
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    fileInput.files = files;
                    handleFileSelect();
                }
            }
            
            function handleFileSelect() {
                const file = fileInput.files[0];
                
                if (file) {
                    // Показать информацию о файле
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    fileInfo.style.display = 'block';
                    
                    // Скрыть предыдущие результаты
                    resultContainer.style.display = 'none';
                    
                    // Активировать кнопку обработки
                    processBtn.disabled = false;
                    
                    // Прокрутить к кнопке обработки
                    processBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Обработка файла
            processBtn.addEventListener('click', async () => {
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Пожалуйста, выберите файл!');
                    return;
                }
                
                // Проверка размера файла (10 МБ)
                if (file.size > 30 * 1024 * 1024) {
                    alert('Файл слишком большой. Максимальный размер: 30 МБ');
                    return;
                }
                
                // Показать спиннер
                spinner.style.display = 'block';
                statusText.textContent = 'Обработка файла...';
                statusText.style.color = '#2c3e50';
                processBtn.disabled = true;
                resultContainer.style.display = 'none';
                
                try {
                    // Отправляем файл на сервер
                    const response = await fetch('https://fixmytrack-github-io.onrender.com/api/v1/fixme', {
                        method: 'POST',
                        headers: {
                            "Content-Type": "application/octet-stream",
                            "X-File-Name": encodeURIComponent(file.name)
                        },
                        body: file
                    });
                    
                    // Обновить статус
                    statusText.textContent = 'Получение результата...';
                    
                    // Проверить статус ответа
                    if (!response.ok) {
                        const error = await response.text();
			alert("Ошибка: " + error);
                        throw new Error(`Ошибка сервера: ${error}`);
                    }
                    
                    // Получить имя файла из заголовков
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let fileName = file.name.replace(/\.[^/.]+$/, "") + "_fixed" + file.name.match(/\.[^/.]+$/);
                    
                    if (contentDisposition) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(contentDisposition);
                        if (matches != null && matches[1]) {
                            fileName = matches[1].replace(/['"]/g, '');
                        }
                    }
                    
			fileName = 'fixed_'+file.name;

                    // Получить данные файла
                    const blob = await response.blob();
                    
                    // Сохранить для скачивания
                    processedFileBlob = blob;
                    processedFileName = fileName;
                    
                    // Обновить UI
                    resultFileName.textContent = fileName;
                    resultFileSize.textContent = formatFileSize(blob.size);
                    
                    // Скрыть спиннер
                    spinner.style.display = 'none';
                    
                    // Показать результат
                    resultContainer.style.display = 'block';
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Разблокировать кнопку для новой загрузки
                    processBtn.disabled = false;
                    
                } catch (error) {
                    console.error("Ошибка:", error);
                    spinner.style.display = 'none';
                    statusText.textContent = 'Ошибка: ' + error.message;
                    statusText.style.color = '#e74c3c';
                    processBtn.disabled = false;
                }
            });
            
            // Обработка скачивания файла
            downloadLink.addEventListener('click', (e) => {
                e.preventDefault();
                
                if (processedFileBlob) {
                    // Создать временную ссылку для скачивания
                    const url = URL.createObjectURL(processedFileBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = processedFileName;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    a.click();
                    
                    // Очистка
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    // Анимация кнопки скачивания
                    const btn = e.currentTarget.querySelector('.download-btn');
                    btn.textContent = '✓ Скачано';
                    btn.style.background = '#2ecc71';
                    
                    setTimeout(() => {
                        btn.textContent = 'Скачать';
                        btn.style.background = '#3498db';
                    }, 10000);
                }
            });
        });
    </script>
</body>
</html>